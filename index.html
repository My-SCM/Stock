<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Inventory Narogong</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse untuk membaca CSV Google Sheets -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Font Awesome untuk Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Animasi Loading */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* --- STICKY HEADERS & FOOTERS CONFIGURATION --- */
        
        /* 1. Header Kolom Utama - STICKY DI BAWAH NAVBAR */
        thead th {
            position: sticky;
            top: 4rem; 
            z-index: 40; 
            /* Menggunakan warna solid yang kuat untuk menutupi konten di bawahnya saat scroll */
            background-color: #f1f5f9; /* bg-slate-100 yang lebih pekat */
            border-bottom: 2px solid #cbd5e1;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); /* Shadow lebih tegas */
            background-clip: padding-box; /* Mencegah border transparan */
        }

        /* 3. Footer Total - STICKY DI BAWAH LAYAR */
        tfoot td {
            position: sticky;
            bottom: 0;
            z-index: 40;
            background-color: #f1f5f9; /* bg-slate-100 */
            border-top: 2px solid #94a3b8;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans min-h-screen flex flex-col">

    <!-- Navbar / Header -->
    <nav class="bg-blue-900 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <i class="fa-solid fa-boxes-stacked text-2xl mr-3"></i>
                    <h1 class="font-bold text-xl tracking-wide">Narogong Inventory Dashboard</h1>
                </div>
                <div class="flex items-center text-sm">
                    <span id="last-update" class="mr-4 text-gray-300 hidden sm:block">Update: -</span>
                    <button onclick="loadData()" class="bg-blue-700 hover:bg-blue-600 px-3 py-1 rounded transition flex items-center gap-2 shadow-sm border border-blue-600">
                        <i class="fa-solid fa-rotate"></i> <span class="hidden sm:inline">Refresh</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium uppercase">Total Item</p>
                        <h2 class="text-3xl font-bold text-gray-800" id="total-items">0</h2>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full text-blue-600">
                        <i class="fa-solid fa-list-ol text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium uppercase">Total Qty Base</p>
                        <h2 class="text-3xl font-bold text-gray-800" id="total-qty-base">0</h2>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full text-green-600">
                        <i class="fa-solid fa-cube text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium uppercase">Lokasi Filter</p>
                        <h2 class="text-lg font-bold text-gray-800">NAROGONG</h2>
                        <p class="text-xs text-gray-500">Zone: FG E & GUDANG FG</p>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-full text-purple-600">
                        <i class="fa-solid fa-location-dot text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="flex flex-col items-center justify-center py-12">
            <div class="spinner mb-4"></div>
            <p class="text-gray-600 animate-pulse">Mengambil data dari Google Sheets...</p>
        </div>

        <!-- Error State -->
        <div id="error-msg" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
            <strong class="font-bold">Terjadi Kesalahan!</strong>
            <span class="block sm:inline" id="error-text">Gagal memuat data.</span>
        </div>

        <!-- Data Table Container -->
        <div id="data-container" class="hidden fade-in bg-white shadow-md rounded-lg overflow-hidden border border-gray-100">
            <!-- Header Tools -->
            <div class="px-6 py-5 border-b border-gray-200 bg-gray-50 flex flex-col lg:flex-row justify-between items-center gap-4">
                <!-- Title Section -->
                <div class="flex items-center gap-3 w-full lg:w-auto">
                    <div class="bg-blue-100 p-2 rounded-lg text-blue-600">
                        <i class="fa-solid fa-table-list"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">Detail Persediaan</h3>
                        <p class="text-xs text-gray-500 hidden sm:block">Data stok realtime terupdate</p>
                    </div>
                </div>

                <!-- Tools Section (Filter, Search, Export) -->
                <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
                     <!-- Filter Dropdown Segment -->
                     <div class="relative w-full sm:w-48 group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 group-hover:text-blue-500 transition-colors">
                            <i class="fa-solid fa-filter text-xs"></i>
                        </div>
                        <select id="segment-filter" onchange="searchTable()" class="pl-9 pr-8 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full bg-white shadow-sm transition-all hover:border-gray-400 cursor-pointer appearance-none text-gray-700 font-medium">
                            <option value="">Semua Segment</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-400">
                            <i class="fa-solid fa-chevron-down text-xs"></i>
                        </div>
                     </div>

                     <!-- Search Input -->
                     <div class="relative w-full sm:w-64 group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400 group-hover:text-blue-500 transition-colors">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </div>
                        <input type="text" id="search-input" onkeyup="searchTable()" placeholder="Cari Item, SKU, atau Nama..." class="pl-10 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full shadow-sm transition-all hover:border-gray-400 text-gray-700">
                     </div>
                     
                     <!-- Export Button -->
                     <button onclick="exportExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-all shadow-sm hover:shadow-md justify-center whitespace-nowrap transform active:scale-95">
                        <i class="fa-solid fa-file-excel"></i> <span class="font-medium">Export Excel</span>
                    </button>
                </div>
            </div>
            
            <!-- Table Wrapper (Horizontal Scroll Only) -->
            <div class="overflow-x-auto bg-white">
                <table class="min-w-full divide-y divide-gray-200 relative border-collapse">
                    <thead class="bg-slate-100">
                        <tr>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-extrabold text-slate-700 uppercase tracking-wider whitespace-nowrap border-r border-gray-200">No</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-extrabold text-slate-700 uppercase tracking-wider whitespace-nowrap border-r border-gray-200">Segment</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-extrabold text-slate-700 uppercase tracking-wider whitespace-nowrap border-r border-gray-200">Item No</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-extrabold text-slate-700 uppercase tracking-wider whitespace-nowrap border-r border-gray-200">Description</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-extrabold text-slate-700 uppercase tracking-wider whitespace-nowrap border-r border-gray-200">UOM</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-extrabold text-slate-700 uppercase tracking-wider whitespace-nowrap border-r border-gray-200">Qty Actual (Rec)</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-extrabold text-slate-700 uppercase tracking-wider whitespace-nowrap border-r border-gray-200">Qty Base</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-extrabold text-slate-700 uppercase tracking-wider whitespace-nowrap border-r border-gray-200">Variance</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Rows will be populated by JS -->
                    </tbody>
                    <!-- Footer untuk Total -->
                    <tfoot id="table-footer" class="bg-slate-100 text-sm border-t-2 border-gray-300">
                        <!-- Total row inserted by JS -->
                    </tfoot>
                </table>
            </div>
            
            <!-- Footer Count -->
            <div class="px-6 py-3 border-t border-gray-200 bg-gray-50 text-sm text-gray-500" id="record-count">
                Menampilkan 0 baris
            </div>
        </div>
    </main>

    <!-- Page Footer -->
    <footer class="bg-white border-t py-4 hidden sm:block">
        <div class="max-w-7xl mx-auto px-4 text-center text-gray-500 text-sm">
            <p>&copy; 2025 Dashboard Inventory by GuoKing_. Data realtime dari Google Sheets.</p>
        </div>
    </footer>

    <script>
        // --- KONFIGURASI URL SPREADSHEET ---
        const SHEET_MAIN = 'https://docs.google.com/spreadsheets/d/1a5GLqM7J2iLtjWErDl1PB47AH0uan_4aA3DZ29C0SEw/export?format=csv&gid=0';
        const SHEET_DESC = 'https://docs.google.com/spreadsheets/d/11-kYb81CtGvf_1ukf_mj6W5Cn_tktqe6blGM4Rc2MZU/export?format=csv&gid=0';
        const SHEET_QTY  = 'https://docs.google.com/spreadsheets/d/1OOhR4CiIgjLNbVdIQsc6bLxz0nCwhr9lDdmL7zm6wIc/export?format=csv&gid=1628010390';

        const REFRESH_INTERVAL = 60000; 
        let currentData = [];

        function fetchCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) { resolve(results); },
                    error: function(err) { reject(err); }
                });
            });
        }

        const cleanStr = (str) => str ? str.toString().trim().toUpperCase() : "";
        const cleanNum = (val) => {
            if (!val) return 0;
            let strVal = val.toString().trim();
            if (strVal === "") return 0;
            let num = parseFloat(strVal.replace(/,/g, ''));
            return isNaN(num) ? 0 : num;
        };

        async function loadData() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('data-container').classList.add('hidden');
            document.getElementById('error-msg').classList.add('hidden');
            
            try {
                const [resMain, resDesc, resQty] = await Promise.all([
                    fetchCSV(SHEET_MAIN),
                    fetchCSV(SHEET_DESC),
                    fetchCSV(SHEET_QTY)
                ]);

                const dataMain = resMain.data;
                const dataDesc = resDesc.data;
                const dataQty = resQty.data;

                // --- 1. PROSES MASTER ITEM ---
                const descHeaders = resDesc.meta.fields || [];
                const descKeys = dataDesc.length > 0 ? Object.keys(dataDesc[0]) : [];
                let descItemKey = descKeys.find(k => k.toLowerCase().includes('item') || k.toLowerCase().includes('no'));
                let descDescKey = descKeys.find(k => k.toLowerCase().includes('desc') || k.toLowerCase().includes('description'));
                
                let segmentHeaderName = null;
                if (descHeaders && descHeaders.length > 6) {
                    segmentHeaderName = descHeaders[6]; // Kolom G (Index 6)
                }

                // Buat Master Map
                const masterMap = new Map();
                dataDesc.forEach(row => {
                    if (descItemKey && row[descItemKey]) {
                        let segmentVal = "-";
                        if (segmentHeaderName && row[segmentHeaderName]) {
                            segmentVal = row[segmentHeaderName];
                        }
                        if (!segmentVal || segmentVal.trim() === "") segmentVal = "UNCATEGORIZED";

                        masterMap.set(cleanStr(row[descItemKey]), {
                            desc: descDescKey ? row[descDescKey] : "Deskripsi tidak ditemukan",
                            segment: segmentVal
                        });
                    }
                });

                // --- 2. PROSES DATA QTY ACTUAL ---
                const qtyHeaders = resQty.meta.fields || [];
                let qtyColumnName = null;
                if (qtyHeaders && qtyHeaders.length > 8) qtyColumnName = qtyHeaders[8]; 
                
                let skuColumnName = null;
                if (qtyHeaders && qtyHeaders.length > 4) skuColumnName = qtyHeaders[4];

                const qtyKeys = dataQty.length > 0 ? Object.keys(dataQty[0]) : [];
                
                // Cari nama kolom exact jika index tidak ketemu
                let qtyItemKey = skuColumnName;
                if (!qtyItemKey) {
                     qtyItemKey = qtyKeys.find(k => {
                        const upper = k.toUpperCase();
                        return upper.trim() === 'SKU' || upper.includes('SKU');
                     });
                }
                
                let qtyValKey = qtyColumnName;
                if (!qtyValKey) {
                    qtyValKey = qtyKeys.find(k => k.trim() === 'Qty' || k.toLowerCase().includes('qty') || k.toLowerCase().includes('quantity'));
                }

                const qtyMap = new Map();
                dataQty.forEach(row => {
                    if (qtyItemKey && qtyValKey && row[qtyItemKey]) {
                        const itemNo = cleanStr(row[qtyItemKey]);
                        const val = cleanNum(row[qtyValKey]);
                        
                        if (itemNo !== "" && itemNo !== "-") {
                            if (qtyMap.has(itemNo)) {
                                qtyMap.set(itemNo, qtyMap.get(itemNo) + val);
                            } else {
                                qtyMap.set(itemNo, val);
                            }
                        }
                    }
                });

                // --- 3. PROSES AGGREGASI DATA UTAMA ---
                const mainKeys = dataMain.length > 0 ? Object.keys(dataMain[0]) : [];
                const mainLocKey = mainKeys.find(k => k.toLowerCase().includes('location') || k.toLowerCase().includes('loc'));
                const mainZoneKey = mainKeys.find(k => k.toLowerCase().includes('zone'));
                const mainItemKey = mainKeys.find(k => k.toLowerCase().includes('item'));
                const mainQtyBaseKey = mainKeys.find(k => k.toLowerCase().includes('base') || k.toLowerCase().includes('quantity_base'));
                const mainUomKey = mainKeys.find(k => k.toLowerCase().includes('unit') || k.toLowerCase().includes('uom'));

                const aggregatedDataMap = new Map();

                // Loop data utama
                dataMain.forEach(row => {
                    const locVal = mainLocKey ? cleanStr(row[mainLocKey]) : "";
                    const zoneVal = mainZoneKey ? cleanStr(row[mainZoneKey]) : "";

                    if (locVal === "NAROGONG" && (zoneVal === "FG E" || zoneVal === "GUDANG FG")) {
                        const itemNo = mainItemKey ? row[mainItemKey] : "-";
                        const cleanItemNo = cleanStr(itemNo);
                        const qtyBase = mainQtyBaseKey ? cleanNum(row[mainQtyBaseKey]) : 0;
                        const uom = mainUomKey ? row[mainUomKey] : "";

                        if (!aggregatedDataMap.has(cleanItemNo)) {
                            aggregatedDataMap.set(cleanItemNo, {
                                item_no: itemNo,
                                cleanItemNo: cleanItemNo,
                                uom: uom,
                                qty_base_total: 0,
                                zone: zoneVal
                            });
                        }

                        const entry = aggregatedDataMap.get(cleanItemNo);
                        entry.qty_base_total += qtyBase;
                        if (uom && uom !== "") entry.uom = uom;
                    }
                });

                // --- 4. MAP KE FINAL DATA ---
                const finalData = Array.from(aggregatedDataMap.values()).map(entry => {
                    const masterDetails = masterMap.get(entry.cleanItemNo) || { desc: "Deskripsi tidak ditemukan", segment: "UNCATEGORIZED" };
                    const qtyActual = qtyMap.get(entry.cleanItemNo) || 0;
                    
                    // Hitung Variance
                    const variance = qtyActual - entry.qty_base_total;

                    return {
                        segment: masterDetails.segment,
                        item_no: entry.item_no,
                        desc: masterDetails.desc,
                        uom: entry.uom || "-",
                        qty_actual: qtyActual,
                        qty_base: entry.qty_base_total,
                        variance: variance,
                        zone: entry.zone
                    };
                }).filter(item => {
                    return (item.qty_actual !== 0 || item.qty_base !== 0);
                });

                // Sort data by Segment then Item No
                finalData.sort((a, b) => {
                    if (a.segment < b.segment) return -1;
                    if (a.segment > b.segment) return 1;
                    return a.item_no.localeCompare(b.item_no);
                });

                populateSegmentFilter(finalData);
                currentData = finalData;
                renderTable(finalData);
                updateStats(finalData);

                const now = new Date();
                document.getElementById('last-update').innerText = `Update: ${now.toLocaleTimeString()}`;

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('data-container').classList.remove('hidden');

            } catch (error) {
                console.error("Error fetching data:", error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error-msg').classList.remove('hidden');
            }
        }

        function populateSegmentFilter(data) {
            const select = document.getElementById('segment-filter');
            const currentSelection = select.value;
            const segments = [...new Set(data.map(item => item.segment))].sort();
            
            select.innerHTML = '<option value="">Semua Segment</option>';
            
            segments.forEach(seg => {
                const option = document.createElement('option');
                option.value = seg;
                option.textContent = seg;
                select.appendChild(option);
            });

            if (segments.includes(currentSelection)) {
                select.value = currentSelection;
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            const tfoot = document.getElementById('table-footer');
            tbody.innerHTML = '';
            tfoot.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">Tidak ada data yang cocok.</td></tr>';
                return;
            }

            let displayIndex = 0;
            let totalActual = 0;
            let totalBase = 0;
            let totalVariance = 0;

            data.forEach((row, index) => {
                totalActual += row.qty_actual;
                totalBase += row.qty_base;
                totalVariance += row.variance;

                displayIndex++;
                const tr = document.createElement('tr');
                tr.className = index % 2 === 0 ? 'bg-white hover:bg-gray-50 data-row transition-colors' : 'bg-gray-50 hover:bg-gray-100 data-row transition-colors';
                tr.dataset.segmentGroup = row.segment; 

                // Styling untuk Variance
                let varianceClass = 'text-gray-900';
                let varianceIcon = '';
                let varianceTooltip = '';
                let cursorStyle = '';

                if (row.variance < 0) {
                    varianceClass = 'text-red-600 font-bold';
                    varianceIcon = '<i class="fa-solid fa-arrow-down mr-1 text-xs"></i>';
                } else if (row.variance > 0) {
                    varianceClass = 'text-green-600 font-bold';
                    varianceIcon = '<i class="fa-solid fa-arrow-up mr-1 text-xs"></i>';
                }

                // Tambahkan tooltip jika ada selisih
                if (row.variance !== 0) {
                    varianceTooltip = 'Perbedaan Qty disebabkan update di stock card tidak real time. Saat akhir shift baru akan diupdate dan dipastikan stock balance antara actual dan sistem.';
                    cursorStyle = 'cursor-help border-b border-dotted border-gray-400';
                }

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono border-r border-gray-100">${displayIndex}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-800 font-bold uppercase tracking-wide border-r border-gray-100"><span class="bg-blue-100 px-2 py-1 rounded text-xs">${row.segment}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600 border-r border-gray-100">${row.item_no}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 max-w-xs truncate md:max-w-none md:whitespace-normal border-r border-gray-100" title="${row.desc}">${row.desc}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 border-r border-gray-100"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">${row.uom}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-100 font-medium">${row.qty_actual.toLocaleString('id-ID')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-100 font-medium">${row.qty_base.toLocaleString('id-ID')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${varianceClass} ${cursorStyle}" title="${varianceTooltip}">
                        ${varianceIcon}${row.variance.toLocaleString('id-ID')}
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // --- RENDER FOOTER TOTAL ---
            // Styling Total Variance
            let totalVarClass = 'text-gray-900';
            if (totalVariance < 0) totalVarClass = 'text-red-700';
            else if (totalVariance > 0) totalVarClass = 'text-green-700';

            tfoot.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-4 text-right text-gray-800 font-extrabold uppercase tracking-wider text-sm">TOTAL KESELURUHAN</td>
                    <td class="px-6 py-4 text-blue-800 font-extrabold text-sm whitespace-nowrap border-l border-gray-300 bg-blue-50">${totalActual.toLocaleString('id-ID')}</td>
                    <td class="px-6 py-4 text-gray-900 font-extrabold text-sm whitespace-nowrap border-l border-gray-300 bg-gray-100">${totalBase.toLocaleString('id-ID')}</td>
                    <td class="px-6 py-4 ${totalVarClass} font-extrabold text-sm whitespace-nowrap border-l border-gray-300 bg-gray-50">${totalVariance.toLocaleString('id-ID')}</td>
                </tr>
            `;

            // Terapkan filter yang mungkin ada
            searchTable();
        }

        function updateStats(data) {
            document.getElementById('total-items').innerText = data.length;
            const totalBase = data.reduce((acc, curr) => acc + curr.qty_base, 0);
            document.getElementById('total-qty-base').innerText = totalBase.toLocaleString('id-ID');
        }

        function searchTable() {
            const input = document.getElementById('search-input');
            const segmentSelect = document.getElementById('segment-filter');
            
            const filterText = input.value.toUpperCase();
            const filterSegment = segmentSelect.value;
            
            const tbody = document.getElementById('table-body');
            const tfoot = document.getElementById('table-footer');
            
            const dataRows = tbody.querySelectorAll('tr.data-row');
            
            let visibleCount = 0;
            let currentFilteredTotalActual = 0;
            let currentFilteredTotalBase = 0;
            let currentFilteredTotalVariance = 0;

            dataRows.forEach(row => {
                const tdItem = row.children[2];
                const tdDesc = row.children[3];
                const groupName = row.dataset.segmentGroup; 
                
                // Ambil nilai Qty dari kolom index 5, 6
                const qtyActualVal = parseFloat(row.children[5].innerText.replace(/\./g, '').replace(/,/g, '.')) || 0;
                const qtyBaseVal = parseFloat(row.children[6].innerText.replace(/\./g, '').replace(/,/g, '.')) || 0;
                // Hitung ulang variance biar akurat
                const varianceVal = qtyActualVal - qtyBaseVal;

                let textContent = (groupName || "") + (tdItem ? tdItem.textContent : "") + (tdDesc ? tdDesc.textContent : "");

                const matchesText = textContent.toUpperCase().indexOf(filterText) > -1;
                const matchesSegment = filterSegment === "" || groupName === filterSegment;

                if (matchesText && matchesSegment) {
                    row.style.display = "";
                    visibleCount++;
                    currentFilteredTotalActual += qtyActualVal;
                    currentFilteredTotalBase += qtyBaseVal;
                    currentFilteredTotalVariance += varianceVal;
                } else {
                    row.style.display = "none";
                }
            });

            document.getElementById('record-count').innerText = `Menampilkan ${visibleCount} baris data`;

            // Style Total Filtered Variance
            let totalVarClass = 'text-gray-900';
            if (currentFilteredTotalVariance < 0) totalVarClass = 'text-red-700';
            else if (currentFilteredTotalVariance > 0) totalVarClass = 'text-green-700';

            if (visibleCount > 0) {
                 tfoot.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-right text-gray-800 font-extrabold uppercase tracking-wider text-sm">TOTAL (FILTERED)</td>
                        <td class="px-6 py-4 text-blue-800 font-extrabold text-sm whitespace-nowrap border-l border-gray-300 bg-blue-50">${currentFilteredTotalActual.toLocaleString('id-ID')}</td>
                        <td class="px-6 py-4 text-gray-900 font-extrabold text-sm whitespace-nowrap border-l border-gray-300 bg-gray-100">${currentFilteredTotalBase.toLocaleString('id-ID')}</td>
                        <td class="px-6 py-4 ${totalVarClass} font-extrabold text-sm whitespace-nowrap border-l border-gray-300 bg-gray-50">${currentFilteredTotalVariance.toLocaleString('id-ID')}</td>
                    </tr>
                `;
                tfoot.style.display = "";
            } else {
                tfoot.style.display = "none";
            }
        }

        function exportExcel() {
            if (!currentData || currentData.length === 0) {
                alert("Tidak ada data untuk diexport!");
                return;
            }

            const segmentSelect = document.getElementById('segment-filter');
            const filterSegment = segmentSelect.value;
            
            let dataToExport = currentData;
            
            if (filterSegment !== "") {
                dataToExport = currentData.filter(item => item.segment === filterSegment);
            }

            const totalActual = dataToExport.reduce((acc, curr) => acc + curr.qty_actual, 0);
            const totalBase = dataToExport.reduce((acc, curr) => acc + curr.qty_base, 0);
            const totalVariance = dataToExport.reduce((acc, curr) => acc + curr.variance, 0);

            const exportData = dataToExport.map((row, index) => ({
                "No": index + 1,
                "Segment": row.segment,
                "Item No": row.item_no,
                "Description": row.desc,
                "UOM": row.uom,
                "Qty Actual": row.qty_actual,
                "Qty Base": row.qty_base,
                "Variance": row.variance
            }));

            exportData.push({
                "No": "",
                "Segment": "TOTAL",
                "Item No": "",
                "Description": "",
                "UOM": "",
                "Qty Actual": totalActual,
                "Qty Base": totalBase,
                "Variance": totalVariance
            });

            const csv = Papa.unparse(exportData);
            const blob = new Blob(["\uFEFF"+csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            const d = new Date();
            const dateStr = d.toISOString().slice(0,10);
            const timeStr = d.toTimeString().slice(0,8).replace(/:/g,"");

            link.setAttribute("href", url);
            link.setAttribute("download", `Inventory_Narogong_${dateStr}_${timeStr}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setInterval(loadData, REFRESH_INTERVAL);
        });
    </script>
</body>
</html>
