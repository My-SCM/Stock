<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Inventory Narogong</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse untuk membaca CSV Google Sheets -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Font Awesome untuk Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Animasi Loading */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* --- STICKY HEADERS & FOOTERS CONFIGURATION --- */
        
        /* 1. Header Kolom Utama (Item No, Desc, dll) - TETAP STICKY DI ATAS */
        thead th {
            position: sticky;
            top: 0; 
            z-index: 50; 
            background-color: #f8fafc; /* bg-slate-50 */
            border-bottom: 2px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* 2. Header Grouping (Segment) - BIASA */
        .group-header td {
            position: static; 
            z-index: 10;
        }

        /* 3. Footer Total - TETAP STICKY DI BAWAH */
        tfoot td {
            position: sticky;
            bottom: 0;
            z-index: 50;
            background-color: #f1f5f9; /* bg-slate-100 */
            border-top: 2px solid #cbd5e1;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans min-h-screen flex flex-col">

    <!-- Navbar / Header -->
    <nav class="bg-blue-900 text-white shadow-lg sticky top-0 z-50 flex-none">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <i class="fa-solid fa-boxes-stacked text-2xl mr-3"></i>
                    <h1 class="font-bold text-xl tracking-wide">Narogong Inventory Dashboard</h1>
                </div>
                <div class="flex items-center text-sm">
                    <span id="last-update" class="mr-4 text-gray-300 hidden sm:block">Update: -</span>
                    <button onclick="loadData()" class="bg-blue-700 hover:bg-blue-600 px-3 py-1 rounded transition flex items-center gap-2">
                        <i class="fa-solid fa-rotate"></i> <span class="hidden sm:inline">Refresh</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-grow flex flex-col h-full">
        
        <!-- Stats Cards (Flex-none) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 flex-none">
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium uppercase">Total Item</p>
                        <h2 class="text-3xl font-bold text-gray-800" id="total-items">0</h2>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full text-blue-600">
                        <i class="fa-solid fa-list-ol text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium uppercase">Total Qty Base</p>
                        <h2 class="text-3xl font-bold text-gray-800" id="total-qty-base">0</h2>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full text-green-600">
                        <i class="fa-solid fa-cube text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium uppercase">Lokasi Filter</p>
                        <h2 class="text-lg font-bold text-gray-800">NAROGONG</h2>
                        <p class="text-xs text-gray-500">Zone: FG E & GUDANG FG</p>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-full text-purple-600">
                        <i class="fa-solid fa-location-dot text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="flex flex-col items-center justify-center py-12">
            <div class="spinner mb-4"></div>
            <p class="text-gray-600 animate-pulse">Mengambil data dari Google Sheets...</p>
        </div>

        <!-- Error State -->
        <div id="error-msg" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
            <strong class="font-bold">Terjadi Kesalahan!</strong>
            <span class="block sm:inline" id="error-text">Gagal memuat data.</span>
        </div>

        <!-- Data Table Container -->
        <div id="data-container" class="hidden fade-in bg-white shadow-md rounded-lg overflow-hidden flex flex-col flex-grow" style="height: calc(100vh - 300px); min-height: 400px;">
            <!-- Header Tools -->
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex-none flex flex-col sm:flex-row justify-between items-center gap-4">
                <h3 class="text-lg font-semibold text-gray-700">Detail Persediaan (Group by Segment)</h3>
                <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                     <!-- Filter Dropdown Segment -->
                     <select id="segment-filter" onchange="searchTable()" class="border border-gray-300 rounded px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-auto bg-white">
                        <option value="">Semua Segment</option>
                     </select>

                     <input type="text" id="search-input" onkeyup="searchTable()" placeholder="Cari Item, Seg, atau Desc..." class="border border-gray-300 rounded px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-64">
                     
                     <button onclick="exportExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1 rounded text-sm flex items-center gap-2 transition whitespace-nowrap justify-center">
                        <i class="fa-solid fa-file-excel"></i> <span class="hidden sm:inline">Export Excel</span> <span class="sm:hidden">Excel</span>
                    </button>
                </div>
            </div>
            
            <!-- Table Wrapper -->
            <div class="overflow-auto flex-grow relative bg-white">
                <table class="min-w-full divide-y divide-gray-200 relative border-collapse">
                    <thead class="bg-slate-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider whitespace-nowrap">No</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider whitespace-nowrap">Item No</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider whitespace-nowrap">Description</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider whitespace-nowrap">UOM</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider whitespace-nowrap">Qty Actual (Rec)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider whitespace-nowrap">Qty Base</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider whitespace-nowrap">Variant</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Rows will be populated by JS -->
                    </tbody>
                    <!-- Footer untuk Total -->
                    <tfoot id="table-footer" class="bg-slate-100 text-sm">
                        <!-- Total row inserted by JS -->
                    </tfoot>
                </table>
            </div>
            
            <!-- Footer Count -->
            <div class="px-6 py-3 border-t border-gray-200 bg-gray-50 text-sm text-gray-500 flex-none" id="record-count">
                Menampilkan 0 baris
            </div>
        </div>
    </main>

    <!-- Page Footer -->
    <footer class="bg-white border-t py-4 flex-none hidden sm:block">
        <div class="max-w-7xl mx-auto px-4 text-center text-gray-500 text-sm">
            <p>&copy; 2024 Dashboard Inventory. Data realtime dari Google Sheets.</p>
        </div>
    </footer>

    <script>
        // --- KONFIGURASI URL SPREADSHEET ---
        const SHEET_MAIN = 'https://docs.google.com/spreadsheets/d/1a5GLqM7J2iLtjWErDl1PB47AH0uan_4aA3DZ29C0SEw/export?format=csv&gid=0';
        const SHEET_DESC = 'https://docs.google.com/spreadsheets/d/11-kYb81CtGvf_1ukf_mj6W5Cn_tktqe6blGM4Rc2MZU/export?format=csv&gid=0';
        const SHEET_QTY  = 'https://docs.google.com/spreadsheets/d/1OOhR4CiIgjLNbVdIQsc6bLxz0nCwhr9lDdmL7zm6wIc/export?format=csv&gid=1628010390';

        const REFRESH_INTERVAL = 60000; 
        let currentData = [];

        function fetchCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) { resolve(results); },
                    error: function(err) { reject(err); }
                });
            });
        }

        const cleanStr = (str) => str ? str.toString().trim().toUpperCase() : "";
        const cleanNum = (val) => {
            if (!val) return 0;
            let strVal = val.toString().trim();
            if (strVal === "") return 0;
            let num = parseFloat(strVal.replace(/,/g, ''));
            return isNaN(num) ? 0 : num;
        };

        async function loadData() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('data-container').classList.add('hidden');
            document.getElementById('error-msg').classList.add('hidden');
            
            try {
                const [resMain, resDesc, resQty] = await Promise.all([
                    fetchCSV(SHEET_MAIN),
                    fetchCSV(SHEET_DESC),
                    fetchCSV(SHEET_QTY)
                ]);

                const dataMain = resMain.data;
                const dataDesc = resDesc.data;
                const dataQty = resQty.data;

                // --- 1. PROSES MASTER ITEM ---
                const descHeaders = resDesc.meta.fields;
                let segmentHeaderName = null;
                if (descHeaders && descHeaders.length > 6) {
                    segmentHeaderName = descHeaders[6]; // Kolom G (Index 6)
                }

                const masterMap = new Map();
                dataDesc.forEach(row => {
                    let keys = Object.keys(row);
                    let itemKey = keys.find(k => k.toLowerCase().includes('item') || k.toLowerCase().includes('no'));
                    let descKey = keys.find(k => k.toLowerCase().includes('desc') || k.toLowerCase().includes('description'));
                    
                    if (itemKey && row[itemKey]) {
                        let segmentVal = "-";
                        if (segmentHeaderName && row[segmentHeaderName]) {
                            segmentVal = row[segmentHeaderName];
                        }
                        if (!segmentVal || segmentVal.trim() === "") segmentVal = "UNCATEGORIZED";

                        masterMap.set(cleanStr(row[itemKey]), {
                            desc: descKey ? row[descKey] : "Deskripsi tidak ditemukan",
                            segment: segmentVal
                        });
                    }
                });

                // --- 2. PROSES DATA QTY ACTUAL ---
                const qtyHeaders = resQty.meta.fields;
                let qtyColumnName = null;
                if (qtyHeaders && qtyHeaders.length > 8) qtyColumnName = qtyHeaders[8]; 
                
                let skuColumnName = null;
                if (qtyHeaders && qtyHeaders.length > 4) skuColumnName = qtyHeaders[4];

                const qtyMap = new Map();
                dataQty.forEach(row => {
                    let keys = Object.keys(row);
                    let itemKey = skuColumnName;
                    if (!itemKey) {
                         itemKey = keys.find(k => {
                            const upper = k.toUpperCase();
                            return upper.trim() === 'SKU' || upper.includes('SKU');
                         });
                    }
                    let qtyKey = qtyColumnName;
                    if (!qtyKey) {
                        qtyKey = keys.find(k => k.trim() === 'Qty' || k.toLowerCase().includes('qty') || k.toLowerCase().includes('quantity'));
                    }

                    if (itemKey && qtyKey && row[itemKey]) {
                        const itemNo = cleanStr(row[itemKey]);
                        const val = cleanNum(row[qtyKey]);
                        
                        if (itemNo === "" || itemNo === "-") return;

                        if (qtyMap.has(itemNo)) {
                            qtyMap.set(itemNo, qtyMap.get(itemNo) + val);
                        } else {
                            qtyMap.set(itemNo, val);
                        }
                    }
                });

                // --- 3. PROSES AGGREGASI DATA UTAMA (MENGHILANGKAN DUPLIKAT) ---
                // Kita gunakan Map untuk menggabungkan baris dengan Item No yang sama
                const aggregatedDataMap = new Map();

                dataMain.forEach(row => {
                    const locKey = Object.keys(row).find(k => k.toLowerCase().includes('location') || k.toLowerCase().includes('loc'));
                    const zoneKey = Object.keys(row).find(k => k.toLowerCase().includes('zone'));
                    const locVal = locKey ? cleanStr(row[locKey]) : "";
                    const zoneVal = zoneKey ? cleanStr(row[zoneKey]) : "";

                    // Filter Lokasi & Zone
                    if (locVal === "NAROGONG" && (zoneVal === "FG E" || zoneVal === "GUDANG FG")) {
                        
                        const itemKey = Object.keys(row).find(k => k.toLowerCase().includes('item'));
                        const qtyBaseKey = Object.keys(row).find(k => k.toLowerCase().includes('base') || k.toLowerCase().includes('quantity_base'));
                        const variantKey = Object.keys(row).find(k => k.toLowerCase().includes('variant'));
                        const uomKey = Object.keys(row).find(k => k.toLowerCase().includes('unit') || k.toLowerCase().includes('uom'));
                        
                        const itemNo = itemKey ? row[itemKey] : "-";
                        const cleanItemNo = cleanStr(itemNo);
                        const qtyBase = qtyBaseKey ? cleanNum(row[qtyBaseKey]) : 0;
                        const variant = variantKey ? row[variantKey] : "";
                        const uom = uomKey ? row[uomKey] : "";

                        // Jika Item No belum ada, buat entry baru
                        if (!aggregatedDataMap.has(cleanItemNo)) {
                            aggregatedDataMap.set(cleanItemNo, {
                                item_no: itemNo,
                                cleanItemNo: cleanItemNo,
                                uom: uom,
                                qty_base_total: 0,
                                variants: new Set(),
                                zone: zoneVal // Simpan zone pertama yg ketemu
                            });
                        }

                        // Update Data Agregat
                        const entry = aggregatedDataMap.get(cleanItemNo);
                        entry.qty_base_total += qtyBase;
                        if (variant && variant.trim() !== "") entry.variants.add(variant);
                        if (uom && uom !== "") entry.uom = uom; // Update UOM jika sebelumnya kosong
                    }
                });

                // --- 4. MAP KE FINAL DATA ---
                const finalData = Array.from(aggregatedDataMap.values()).map(entry => {
                    const masterDetails = masterMap.get(entry.cleanItemNo) || { desc: "Deskripsi tidak ditemukan", segment: "UNCATEGORIZED" };
                    const qtyActual = qtyMap.get(entry.cleanItemNo) || 0;
                    
                    // Gabungkan variant menjadi string
                    const variantStr = Array.from(entry.variants).join(", ") || "-";

                    return {
                        segment: masterDetails.segment,
                        item_no: entry.item_no,
                        desc: masterDetails.desc,
                        uom: entry.uom || "-",
                        qty_actual: qtyActual,
                        qty_base: entry.qty_base_total,
                        variant: variantStr,
                        zone: entry.zone
                    };
                }).filter(item => {
                    // Filter: Tampilkan jika salah satu Qty tidak nol
                    return (item.qty_actual !== 0 || item.qty_base !== 0);
                });

                finalData.sort((a, b) => {
                    if (a.segment < b.segment) return -1;
                    if (a.segment > b.segment) return 1;
                    return 0;
                });

                // Populate Segment Dropdown
                populateSegmentFilter(finalData);

                currentData = finalData;
                renderTable(finalData);
                updateStats(finalData);

                const now = new Date();
                document.getElementById('last-update').innerText = `Update: ${now.toLocaleTimeString()}`;

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('data-container').classList.remove('hidden');

            } catch (error) {
                console.error("Error fetching data:", error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error-msg').classList.remove('hidden');
            }
        }

        function populateSegmentFilter(data) {
            const select = document.getElementById('segment-filter');
            // Simpan nilai seleksi saat ini agar tidak reset saat auto-refresh
            const currentSelection = select.value;
            
            // Ambil unique segments dan urutkan
            const segments = [...new Set(data.map(item => item.segment))].sort();
            
            // Reset opsi (tetap simpan opsi "Semua Segment")
            select.innerHTML = '<option value="">Semua Segment</option>';
            
            segments.forEach(seg => {
                const option = document.createElement('option');
                option.value = seg;
                option.textContent = seg;
                select.appendChild(option);
            });

            // Restore selection jika masih valid
            if (segments.includes(currentSelection)) {
                select.value = currentSelection;
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            const tfoot = document.getElementById('table-footer');
            tbody.innerHTML = '';
            tfoot.innerHTML = '';

            // Note: Data yang masuk ke sini adalah full data.
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Tidak ada data yang cocok.</td></tr>';
                return;
            }

            let lastSegment = null;
            let displayIndex = 0;
            let totalActual = 0;
            let totalBase = 0;

            data.forEach((row, index) => {
                totalActual += row.qty_actual;
                totalBase += row.qty_base;

                if (row.segment !== lastSegment) {
                    const trHeader = document.createElement('tr');
                    trHeader.className = "group-header bg-gray-100";
                    trHeader.dataset.segment = row.segment; 
                    trHeader.innerHTML = `
                        <td colspan="7" class="px-6 py-2 border-b border-blue-200 bg-blue-50 text-blue-900 font-bold">
                            <i class="fa-solid fa-layer-group mr-2"></i> ${row.segment}
                        </td>
                    `;
                    tbody.appendChild(trHeader);
                    lastSegment = row.segment;
                }

                displayIndex++;
                const tr = document.createElement('tr');
                tr.className = index % 2 === 0 ? 'bg-white hover:bg-gray-50 data-row' : 'bg-gray-50 hover:bg-gray-100 data-row';
                tr.dataset.segmentGroup = row.segment; 

                const qtyDiffClass = (row.qty_base !== row.qty_actual) ? 'text-amber-600 font-semibold' : 'text-gray-900';

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${displayIndex}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600">${row.item_no}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 max-w-xs truncate md:max-w-none md:whitespace-normal" title="${row.desc}">${row.desc}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">${row.uom}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${qtyDiffClass}">${row.qty_actual.toLocaleString('id-ID')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row.qty_base.toLocaleString('id-ID')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.variant}</td>
                `;
                tbody.appendChild(tr);
            });

            // --- RENDER FOOTER TOTAL ---
            tfoot.innerHTML = `
                <tr>
                    <td colspan="4" class="px-6 py-3 text-right text-gray-700 font-bold uppercase tracking-wider">TOTAL KESELURUHAN</td>
                    <td class="px-6 py-3 text-blue-700 font-bold text-sm whitespace-nowrap border-l border-gray-300">${totalActual.toLocaleString('id-ID')}</td>
                    <td class="px-6 py-3 text-gray-900 font-bold text-sm whitespace-nowrap border-l border-gray-300">${totalBase.toLocaleString('id-ID')}</td>
                    <td class="px-6 py-3 border-l border-gray-300"></td>
                </tr>
            `;

            // Terapkan filter yang mungkin ada (misal setelah refresh)
            searchTable();
        }

        function updateStats(data) {
            document.getElementById('total-items').innerText = data.length;
            const totalBase = data.reduce((acc, curr) => acc + curr.qty_base, 0);
            document.getElementById('total-qty-base').innerText = totalBase.toLocaleString('id-ID');
        }

        function searchTable() {
            const input = document.getElementById('search-input');
            const segmentSelect = document.getElementById('segment-filter');
            
            const filterText = input.value.toUpperCase();
            const filterSegment = segmentSelect.value;
            
            const tbody = document.getElementById('table-body');
            const tfoot = document.getElementById('table-footer');
            
            const dataRows = tbody.querySelectorAll('tr.data-row');
            const headerRows = tbody.querySelectorAll('tr.group-header');
            
            let visibleSegments = new Set();
            let visibleCount = 0;
            let currentFilteredTotalActual = 0;
            let currentFilteredTotalBase = 0;

            dataRows.forEach(row => {
                const tdItem = row.children[1];
                const tdDesc = row.children[2];
                const groupName = row.dataset.segmentGroup;
                
                // Ambil nilai Qty dari kolom (index 4 dan 5)
                const qtyActualVal = parseFloat(row.children[4].innerText.replace(/\./g, '').replace(/,/g, '.')) || 0;
                const qtyBaseVal = parseFloat(row.children[5].innerText.replace(/\./g, '').replace(/,/g, '.')) || 0;

                let textContent = (groupName || "") + (tdItem ? tdItem.textContent : "") + (tdDesc ? tdDesc.textContent : "");

                // Cek filter: Text Matches AND Segment Matches
                const matchesText = textContent.toUpperCase().indexOf(filterText) > -1;
                const matchesSegment = filterSegment === "" || groupName === filterSegment;

                if (matchesText && matchesSegment) {
                    row.style.display = "";
                    visibleSegments.add(groupName);
                    visibleCount++;
                    currentFilteredTotalActual += qtyActualVal;
                    currentFilteredTotalBase += qtyBaseVal;
                } else {
                    row.style.display = "none";
                }
            });

            headerRows.forEach(header => {
                if (visibleSegments.has(header.dataset.segment)) {
                    header.style.display = "";
                } else {
                    header.style.display = "none";
                }
            });

            document.getElementById('record-count').innerText = `Menampilkan ${visibleCount} baris data`;

            // Update Footer Total berdasarkan hasil search
            if (visibleCount > 0) {
                 tfoot.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-3 text-right text-gray-700 font-bold uppercase tracking-wider">TOTAL (FILTERED)</td>
                        <td class="px-6 py-3 text-blue-700 font-bold text-sm whitespace-nowrap border-l border-gray-300">${currentFilteredTotalActual.toLocaleString('id-ID')}</td>
                        <td class="px-6 py-3 text-gray-900 font-bold text-sm whitespace-nowrap border-l border-gray-300">${currentFilteredTotalBase.toLocaleString('id-ID')}</td>
                        <td class="px-6 py-3 border-l border-gray-300"></td>
                    </tr>
                `;
                tfoot.style.display = "";
            } else {
                tfoot.style.display = "none";
            }
        }

        function exportExcel() {
            if (!currentData || currentData.length === 0) {
                alert("Tidak ada data untuk diexport!");
                return;
            }

            // Saat export, kita cek filter yang aktif
            const segmentSelect = document.getElementById('segment-filter');
            const filterSegment = segmentSelect.value;
            
            // Filter data sesuai dropdown
            let dataToExport = currentData;
            
            if (filterSegment !== "") {
                dataToExport = currentData.filter(item => item.segment === filterSegment);
            }

            const totalActual = dataToExport.reduce((acc, curr) => acc + curr.qty_actual, 0);
            const totalBase = dataToExport.reduce((acc, curr) => acc + curr.qty_base, 0);

            const exportData = dataToExport.map((row, index) => ({
                "No": index + 1,
                "Segment": row.segment,
                "Item No": row.item_no,
                "Description": row.desc,
                "UOM": row.uom,
                "Qty Actual": row.qty_actual,
                "Qty Base": row.qty_base,
                "Variant": row.variant
            }));

            // Append Total Row
            exportData.push({
                "No": "",
                "Segment": "TOTAL",
                "Item No": "",
                "Description": "",
                "UOM": "",
                "Qty Actual": totalActual,
                "Qty Base": totalBase,
                "Variant": ""
            });

            const csv = Papa.unparse(exportData);
            const blob = new Blob(["\uFEFF"+csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            const d = new Date();
            const dateStr = d.toISOString().slice(0,10);
            const timeStr = d.toTimeString().slice(0,8).replace(/:/g,"");

            link.setAttribute("href", url);
            link.setAttribute("download", `Inventory_Narogong_${dateStr}_${timeStr}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setInterval(loadData, REFRESH_INTERVAL);
        });
    </script>
</body>
</html>
